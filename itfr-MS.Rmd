---
output: 
  pdf_document:
    number_sections: true
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: C:/Users/Matt/Documents/Matt - Work Stuff/r code/delete/svm-latex-ms.tex
title: "A scale- and time-independent technique for estimating total fertility rates from age-sex distributions"
thanks: "The data and code that supports this analysis are available in the supplementary materials."
author:
- name: Mathew E. Hauer ^1^*
  affiliation: University of Georgia
- name: Carl P. Schmertmann ^2,3^
  affiliation: Florida State University

abstract: "Recent methodological advances in indirect migration and mortality estimation for small populations [@abel2014;@simini2012;@dwyer2017] have revealed important patterns, but accurate estimation of fertility for small or specialized populations remains elusive. The primary fertility index for a population , the total fertility rate (TFR), requires accurate data on births disaggregated by mother’s age. TFR is thus incalculable for the many areas and time periods that lack such information. Here we discuss a universal methodological framework for estimating TFR that uses inputs as minimal as the age-sex structure of a population. The implied total fertility rate (iTFR) accurately estimates fertility from a population's age-sex structure in a wide range of scales, time periods, and even species. We also discuss two extensions of the iTFR, called xTFR and BayesTFR, that offer improved accuracy with minimal additional data requirements. To demonstrate the utility of this approach, we produce the first complete county-level map of US fertility, reconstruct historical TFRs for three European countries up to 150 years prior to the collection of any birth records, and estimate TFR for the United States conditioned on household income, a variable that is not recorded in US birth records. Given its parameter-free nature, the method captures fundamental qualities that govern fertility with a near universal applicability across space and time. We anticipate that our methodological framework will be a starting point for more sophisticated fertility analyses in previously inestimable sub-populations, time periods, and geographies, significantly expanding our ability to understand the nature of fertility."
#keywords: "Louisiana, Hurricane Katrina, Sea Level Rise, Adaptation, Migration, Coastal Populations, Landward Migration"
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
#fontfamily: mathpazo
fontsize: 12pt
spacing: double
bibliography: C:/Users/Matt/Documents/Untitled/mybibfile.bib
biblio-style: nature
# use apsr or nature
header-includes:
- \usepackage[all]{nowidow}
- \usepackage{rotating}
- \usepackage{amsmath}
#- \usepackage{lineno}
#- \linenumbers


---
\* Corresponding author. hauer\@uga.edu. p: 706-542-9369.

^1^ Carl Vinson Institute of Government, University of Georgia. 201 N. Milledge Ave. Athens, GA USA 30602.

^2^ Department of Economics, Florida State University.

^3^ Center for Demography and Population Health, Florida State University.

\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list=ls())
library(tidyverse)
library(ggrepel)
library(grid)
library(gridExtra)
library(HMDHFDplus)
library(scales)
library(dplyr)
library(openxlsx) 
library(tmap)
library(tmaptools)
library(tigris)
library(censusapi)
library(tidycensus)
```

```{r basecode, include = FALSE, cache =TRUE}
PRIM_DATA <- read_csv("Bronikowski.LifeTables.SciData2016.csv")

d <- PRIM_DATA %>%
  mutate(child = N.x.female + N.x.male,
         nFx = Offspring / Breeding_females,
         nFx = ifelse(is.na(nFx),0, nFx))

children <- d %>%
  filter(Age == 0) %>%
  select(Species, child)

women <- d %>%
  group_by(Species) %>%
  summarize(Women = sum(N.x.female[fertint > 0]),
            fertwidth = sum(fertint))

TFR_table <- d %>%
  group_by(Species) %>%
  summarize(TFR_table = sum(nFx))

cw <- inner_join(children, women)

combined <- inner_join(cw, TFR_table) %>%
  mutate(iTFR = (child/Women) * fertwidth)


my_groba = grobTree(textGrob("a", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobb = grobTree(textGrob("b", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobc = grobTree(textGrob("c", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobd = grobTree(textGrob("d",x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobe = grobTree(textGrob("e", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobf = grobTree(textGrob("f", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobg = grobTree(textGrob("g", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobh = grobTree(textGrob("h", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobi = grobTree(textGrob("i", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobj = grobTree(textGrob("j", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobk = grobTree(textGrob("k", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))
my_grobl = grobTree(textGrob("l", x=0.9, y=0.1, hjust=0, gp=gpar(col="black", size=6)))

z <- read.csv("bayesitfr_hmdhfd3.csv") %>%
  select(Code, Year, iTFR, lagTFR, bayesTFR=post_mean)

bayesTFR <- read_csv("bayesitfr_hmdhfd3.csv")
xitfr <- read_csv("xTFR_06082017.csv")


join = inner_join(xitfr, z, c("Code", "Year"))

join = join %>%
  select(Code, Year, iTFR=iTFR.x, xTFR, C,lagTFR=lagTFR.x, bayesTFR)

###   My Census API key   ###
census_api_key("0206e3f2924a424be8722887fd0a49cea6308a7e")

# a function to calculate five-year averages of TFR
# given vector X of length L, returns
#   NA NA NA NA,  mean( X[1:5]), mean(X[2:6]), ..., mean(X[(L-4):L])
mean_lag5 = function(X) {
  if (length(X) > 4) {
    Z = sapply( 5:length(X),  function(i) mean(X[i - 0:4]))
    Z = c( rep(NA,4), Z)
  } else {
    Z = rep(NA, length(X))
  }  
  return(Z)
}

# set up data from Human FERTILITY database files
# 
# remove GBR_NP and DEUTNP observations, because those
# countries are subdivided and we don't want to double count

discard = c('GBR_NP', 'DEUTE', 'DEUTW')

HFD_expos = readHFD('exposRR.txt') %>%
  filter(Age %in% 15:49, !(Code %in% discard)) %>%
  mutate(AgeGroup = 5 * floor(Age/5)) %>%
  group_by(Code,Year,AgeGroup) %>%
  summarize(W = sum(Exposure)) %>%
  spread(key=AgeGroup, value=W, sep='_') %>%
  dplyr::select(Code,Year,W=starts_with('AgeGroup')) %>%
  ungroup()

HFD_tfr = readHFD('tfrRR.txt') %>%
  filter(!(Code %in% discard)) %>%
  dplyr::select(-TFR40)


HFD_births = readHFD('totbirthsRR.txt') %>%
  filter(!(Code %in% discard)) %>%
  dplyr::select(Births=Total, Code=Code, Year=Year)

HMD_population = data.frame()
lt_both = data.frame()

# set up data from Human MORTALITY database files
for (this.country in unique(HFD_expos$Code)) {
  filename = paste0(this.country,'.Population5.txt')
  unzip(zipfile='HMD_population.zip', 
        files=paste0('Population5/',filename),
        junkpaths=TRUE)
  
  tmp = read.table(filename, skip=2, stringsAsFactors = FALSE,
                   header=TRUE)
  
  # Some countries have YYYY+ and YYYY- versions of Year, for yrs in
  # which territory changed (AK and HI in 1959 US, NF in 1949 Canada, etc)
  # In all cases we discard the "-" versions, and remove the "+"
  
  minus_ix = grep('-', tmp$Year)
  if (length(minus_ix) > 0)  tmp = tmp[-minus_ix, ]
  
  plus_ix = grep('+', tmp$Year)
  if (length(plus_ix) > 0)  tmp$Year[plus_ix] = substr(tmp$Year,1,4)
  
  
  
  tmp = tmp %>%
    mutate(Code = this.country,
           Year = as.integer(Year))
  
  tmp$Age = c(0,1,seq(5,110,5))   # replace with numeric
  
  tmp = tmp %>%
    group_by(Code, Year) %>%
    summarize( C = sum(Total[Age %in% 0:1]),
               W15 = Female[Age == 15],
               W20 = Female[Age == 20],
               W25 = Female[Age == 25],
               W30 = Female[Age == 30],
               W35 = Female[Age == 35],
               W40 = Female[Age == 40],
               W45 = Female[Age == 45],
               W   = sum(Female[Age %in% seq(15,45,5)]),
               p2534 = (W25+W30)/W,
               iTFR = 7*C/W) %>%
    ungroup()
  
  HMD_population = rbind(HMD_population, tmp)
  
  file.remove(filename)
  
} # for this.country

# Merge
for (this.country in unique(HFD_expos$Code)) {
  filename = paste0(this.country,'.bltper_1x1.txt')
  unzip(zipfile='lt_both.zip', 
        files=paste0('bltper_1x1/',filename),
        junkpaths=TRUE)
  
  tmp = read.table(filename, skip=2, stringsAsFactors = FALSE,
                   header=TRUE)
  
  # Some countries have YYYY+ and YYYY- versions of Year, for yrs in
  # which territory changed (AK and HI in 1959 US, NF in 1949 Canada, etc)
  # In all cases we discard the "-" versions, and remove the "+"
  
  minus_ix = grep('-', tmp$Year)
  if (length(minus_ix) > 0)  tmp = tmp[-minus_ix, ]
  
  plus_ix = grep('+', tmp$Year)
  if (length(plus_ix) > 0)  tmp$Year[plus_ix] = substr(tmp$Year,1,4)
  
  
  
  tmp = tmp %>%
    mutate(Code = this.country,
           Year = as.integer(Year))
  
  #tmp$Age = c(0,1,seq(5,110,5))   # replace with numeric
  
  tmp = tmp %>%
    filter(Age==0)
  #  group_by(Code, Year) %>%
  #  summarize(q1 = qx[Age == 0]   %>%
  #  ungroup()
  
  
  lt_both = rbind(lt_both, tmp)
  
  file.remove(filename)
  
} # for this.country

earliest.year = 1891

tmp1 = left_join(HFD_tfr, 
                 dplyr::select(HMD_population, Code, Year, C, contains('W'), iTFR, p2534), 
                 by=c('Code','Year'))

tmp = left_join(tmp1, 
                dplyr::select(lt_both, Code, Year, qx), 
                by=c('Code','Year'))

## calculate the lagged TFR values for each country
tmp$lagTFR = NA

for (this.country in unique(tmp$Code)) {
  ix = which(tmp$Code == this.country)
  tmp$lagTFR[ix] = mean_lag5( tmp$TFR[ix])  
} # for this.country

tmp = tmp %>%
  filter(Year >= earliest.year, !is.na(iTFR)) %>%   
  mutate( CWR    = C/W,
          mult   = lagTFR/CWR,
          p15    = W15/W,
          p20    = W20/W,
          p25    = W25/W,
          p30    = W30/W,
          p35    = W35/W,
          p40    = W40/W,
          p45    = W45/W,
          decade = as.factor( 10 * floor(Year/10)) )

sample_ids <- sample(1:nrow(tmp), 600, replace=FALSE)
sample_in <- tmp[sample_ids,]
sample_out <- tmp[-sample_ids,]

reg = lm( mult ~ p2534, data=sample_in) 
reg2 = lm( mult ~ -1+p15+p20+p25+p30+p35+p40+p45, data=sample_in) 

beta = coef(reg2)


###   Importing the Natality files from CDC Wonder for US Counties, 2007-2010   ###
tfr_county0710 <- read_tsv("Natality, 2007-2010.txt") %>%
  dplyr::select(County, CountyCode, AgeofMother9Code, Year, Births, FemalePopulation) %>% # selecting specific values
  mutate(YearCode = as.numeric(Year)) # Year is sometimes weird, this converts it to numeric

###   Importing the Natality file from CDC Wonder for US Counties, 2006-2010   ###
tfr_county06 <- read_tsv("Natality, 2003-2006.txt")%>%
  dplyr::select(County, CountyCode, AgeofMother9Code, Year, Births, FemalePopulation) %>%
  mutate(YearCode = as.numeric(Year)*1)

###   Merging the two Natality files together   ###
tfr_county <- full_join(tfr_county06, tfr_county0710) %>%
  filter(!is.na(County))  %>% # dropping all of the extra stuff at the bottom of the CDC's output
  group_by(County, CountyCode, Year) %>%
  mutate(fertrat = (Births / as.numeric(FemalePopulation))*5) %>% # Calculating ASFRs
  summarize(TFR = sum(na.omit(fertrat))) # Calculating the TFR

###   Calculating the lagged TFR values
tfr_county$lagTFR = NA

for (this.county in unique(tfr_county$CountyCode)) {
  ix = which(tfr_county$CountyCode == this.county)
  tfr_county$lagTFR[ix] = mean_lag5( tfr_county$TFR[ix])  
}

###   Importing the Census 2010 information for US Counties
census_county <- read_csv("ift_county_data_c2010.csv") %>%
  mutate(W = (W1517 +  W1819 + W20 + W21 + W2224 + W2529 + W3034 + W3539 + W4044 + W4549), # estimating total number of Women
         CWR = (m0004 + W0004) / W, # estimating Child-woman ratio
         p2534 = (W2529 + W3034) / W, # estimating the proportion of women aged 25-34
         xTFR = (coef(reg)[1] + coef(reg)[2] * p2534) * CWR, # applying the regression coefficients from the HMD/HFD to US counties
         CountyCode = sprintf("%05d", KEY),
         Year = 2010) %>%
  dplyr::select(CountyCode, xTFR, Year) %>%
  left_join(., tfr_county)

###   Estimating the 50th percentile error rate from the xTFR method
countyeval <- census_county %>%
  mutate(num = if_else(lagTFR >0,1,0)) %>%
  summarize(tot = sum(num, na.rm = T) ,
            qlagTFR50 = quantile(abs(xTFR / lagTFR -1), 0.5, na.rm=T),
            qlagTFR90 = quantile(abs(xTFR / lagTFR -1), 0.9, na.rm=T),
            qlagTFR_abs50 = quantile(abs(xTFR - lagTFR), 0.5, na.rm=T),
            qlagTFR_abs90 = quantile(abs(xTFR - lagTFR), 0.9, na.rm=T))

### Selecting the lagged TFR from the 5-year time series for merging with the shapefile.
selectcnties <- census_county %>%
  filter(!is.na(lagTFR))


counties <- counties(cb = TRUE)
countiestfr <- append_data(counties, census_county, key.shp = "GEOID", key.data = "CountyCode", ignore.duplicates = TRUE) %>%
  subset(!(STATEFP %in% c("02", "60", "64","66", "68", "69", "70", "74", "15","72", "78")))
countiestfr2 <- append_data(counties, selectcnties, key.shp = "GEOID", key.data = "CountyCode", ignore.duplicates = TRUE) %>%
  subset(!(STATEFP %in% c("02", "60", "64","66", "68", "69", "70", "74", "15","72", "78"))) %>%
  subset(!is.na(xTFR))

states <- states(cb=TRUE)

itfrape50 <- quantile(abs((join$iTFR-join$lagTFR)/join$lagTFR)*100, 0.5, na.rm=T)
itfrape90 <- quantile(abs((join$iTFR-join$lagTFR)/join$lagTFR)*100, 0.9, na.rm=T)
xtfrape50 <- quantile(abs((join$xTFR-join$lagTFR)/join$lagTFR)*100, 0.5, na.rm=T)
xtfrape90 <- quantile(abs((join$xTFR-join$lagTFR)/join$lagTFR)*100, 0.9, na.rm=T)
bayestfrape50 <- quantile(abs((join$bayesTFR-join$lagTFR)/join$lagTFR)*100, 0.5, na.rm=T)
bayestfrape90 <- quantile(abs((join$bayesTFR-join$lagTFR)/join$lagTFR)*100, 0.9, na.rm=T)

itfrabs50 <- quantile(abs((join$iTFR-join$lagTFR)), 0.5, na.rm=T)
itfrabs90 <- quantile(abs((join$iTFR-join$lagTFR)), 0.9, na.rm=T)
xtfrabs50 <- quantile(abs((join$xTFR-join$lagTFR)), 0.5, na.rm=T)
xtfrabs90 <- quantile(abs((join$xTFR-join$lagTFR)), 0.9, na.rm=T)
bayestfrabs50 <- quantile(abs((join$bayesTFR-join$lagTFR)), 0.5, na.rm=T)
bayestfrabs90 <- quantile(abs((join$bayesTFR-join$lagTFR)), 0.9, na.rm=T)

```

# Main Text
Fertility is the primary engine of global population change [@gerland2014] and is linked to the United Nation's Sustainable Development Goals for female education, child and maternal mortality, gender equality, and reproductive health [@abel16]. The total fertility rate (TFR; the expected number of children born over a complete reproductive lifetime) is widely regarded as one of the most important components of population change and has been extensively used throughout the 20th Century in a range of applications [@yule1906changes;@lutz2011;@shenk13;@lesthaeghe14;@myrskyla;@lee;@kaiser;@conley;@jones;@currie].

Although the conventional technique for calculating TFR is straightforward, it requires data on births disaggregated by mother's age. This makes TFR incalculable in several situations: (i) for countries and regions that lack detailed birth records, (ii) for historical populations without vital event registration, such as the United States prior to 1933, (iii) for small-area populations when reporting agencies mask birth records for privacy reasons, and (iv) for any subpopulation not identified on official birth records, such as the women in a specific income decile, religion, tribe, or caste. The need for disaggregation of births by mother's age thus limits fertility analysis mainly to large populations in contemporary countries with good vital registration systems. 

Numerous indirect estimation techniques have been proposed to circumvent these limitations [@bogue64;@hanson63;@rele67]. 
These methods are often regression-based, and they rely on covariates -- such as mean age at marriage, percent of women ever married, etc. -- that may be absent from census data and therefore need to collected in surveys. The resulting scale- and time-dependent estimates are often inaccurate, [@tuchfeld74;@hauer13] and, like TFR, limited to areas, time periods, and populations with the requisite population and survey data.

Here we discuss a modeling framework that overcomes these problems and demonstrate the near universal applicability of a parameter-free estimation method. 

We first approximate TFR using a variant of the general fertility rate (the total observed births divided by the total number of reproductive age women), in which we substitute the number of enumerated children for recorded births. Then, based only on accurate population counts by age and sex, we develop more complex versions that can accurately estimate total fertility rates over numerous scales, time periods, sub-populations, and even species.

Demographic calculations in the Supplementary Material show that the expected number of surviving children of both sexes, per woman in reproductive age groups at the end of an $n$-year period is the product of three factors: $\frac{C}{W}=s_0\cdot\bar{p}\cdot TFR$. These three factors are:
\begin{enumerate}
\item 	
		Child mortality, $s_0$. This is the expected fraction of children still alive among those born in the past $n$ years, derived from person-years in a life table population with radix $l_0=1$ as $_{n}L_0/n$. 

\item
	A population-weighted index of the age-specific fertility schedule, $\bar{p}$. This represents the average share of lifetime fertility that women in the population experienced over the past five years, after a small adjustment for the possible mortality of adult women. It depends on the relative age pattern of fertility from menarche to menopause, $\phi_{15}...\phi_{45}$ for human populations, on the current age-specific populations of women ($W_{15}...W_{45}$), and on the potential mortality of women of childbearing ages ($L_{15}...L_{45}$ ).
    
\item
  The total fertility rate, TFR. 
\end{enumerate}


One can thus calculate TFR as 
\[
TFR = \frac{1}{s_0}\cdot\frac{1}{\bar{p}}\cdot\frac{C}{W}
\]
the product of the child/woman ratio and two additional factors –- a child mortality multiplier $1/ s_0$  and an age structure multiplier $1/ \bar{p}$ (equation: \ref{eq:Ka}). 

If women of reproductive age are uniformly distributed over seven five-year age groups, $a= 15...45$, then $\bar{p}\approx1/7$ and the age structure multiplier is approximately 7. We show that the simplest approximation, child-mortality near zero ($s_0 \approx 1$) and a uniform age-distribution of women across the reproductive age groups ($\bar{p} \approx 1/7$), still produces accurate estimates of total fertility within 0.25 children, making the approach parameter free without loss of significant accuracy (supplementary materials and Figure 1). This leaves the child/woman ratio as the dominant input to determining fertility levels. We refer to this simplest approximation as the implied or intrinsic total fertility rate (iTFR), representing the fertility rate implied the age-sex structure of a given population [@hauer13;@schmertmann2017bayesian]. We calculate implied fertility as

\begin{equation}{iTFR}
    =\frac{\beta - \alpha}{n}\cdot \frac{ _{n}C_0}{W} \label{eq:implied TFR} 
\end{equation}
where $\alpha$ and $\beta$ are the minimum age at menarche and maximum age at menopause, respectively, $_{n}C_0$ is the number of children under age $n$, and $W$ is the number of women between ages $\alpha$ and $\beta$.

Equation \ref{eq:implied TFR} resolves the limitations of the conventional technique for calculating TFR, freeing the estimation of TFR from the burden of detailed birth records. Instead, the approach produces estimates with as few inputs as basic age-sex counts -- common data collected in censuses. It also has no other tunable parameters allowing for a near universal deployment of the method. Of course the method does require accurate population data, making it more in--common with the demographic accounting equation than more traditional estimation methods. Thus, (eq. \ref{eq:implied TFR}) represents the parameter-free, fundamental equation of implied fertility. Finally, the implied fertility rate can be applied within stochastic frameworks, estimating both TFR and its variance as well as the sensitivity of TFR calculation under various mortality regimes. 

To test the flexibility of our measure and its ability to estimate TFR in a variety of data situations, we present three derivations of the implied fertility rate (see supplementary material) with increasing complexity and subsequent data requirements -– a deterministic formulation based on the algebraic rearrangement, iTFR (equation: \ref{eq:implied TFR})(\textbf{Fig. 1, left column}), a regression-based formulation conditional on the age-structure (essentially incorporating $1/\bar{p}$ into the estimation), xTFR (equation: \ref{eq:kTFR})(\textbf{Fig. 1, middle column}), and a complete Bayesian approach based on child- and maternal-mortality, the female reproductive age-structure, and potential underenumeration of children and reproductive-age women (incorporating both $1/\bar{p}$ and $1/s_0$), BayesTFR (equation: \ref{eq:marginal posterior of TFR})(\textbf{Fig. 1, right column}). These deviations allow us to quantify the source of error in equation \ref{eq:implied TFR}. 

```{r fig1, echo= FALSE, message = FALSE, warning = FALSE, fig.height=6.5, fig.cap= paste("**The implied Total Fertility Rate.** We compare the performance of three formulations of the implied total fertility rate against observed total fertility rates. (a, d, g) in the first column use $p(TFR)=n(C/W)$; (b, e, h) in the second column use $p(TFR)=x(C/W)$ where $x$ is derived from the ratio of women aged 25-34 to all women of childbearing ages; (c, f, i) in the third column estimates TFR conditional on $C,W,k,q_5,\\beta$. (a, b, c) are scatter plots of the estimated TFR against the observed 5-year average TFR from fertility schedules in the Human Fertility Database for 1891-2015. The solid line is Y=X, and the dashed lines represent +/- 10% of Y=X. (d, e, f) demonstrate the percent error, M(TFR), for each method against population sized $n$. The dashed lines represent 10%. (g, h, i) plot the percent errors, M(TFR), for each method for the period 1891-2015, $t$. The dashed lines represent 10%. (j) plots the distribution of algebraic errors for each method. The dashed lines correspond to the 10th and 90th percentile errors for each method. (k) plots the distribution of absolute algebraic errors. (l) plots the distribution of absolute percent errors for each method. The solid lines correspond to the 50th percentile error, and the dashed lines correspond to the 90th percentile errors for each method. Regardless of formulation, the iTFR demonstrates scale and time independence to a high degree of accuracy. \\label{figure1}")}

###   Making the Figure 1 graphic
f1a <- ggplot(data=join, aes(x=lagTFR, y=iTFR)) +
  geom_text(x=1.5, y=3.5, label="iTFR", col='red', size=6)+
  annotation_custom(my_groba)+
  geom_point(size=1, alpha=.50,color='gray') +
  geom_abline(intercept=0,slope=1) +
  theme_bw() +
  theme(legend.position="none")+
  theme(text=element_text(face='bold')) +
  xlim(0.9,4.1) + ylim(0.9,4.1) +
  labs(x='TFR (Data)', y='p(TFR)') +
  geom_abline(slope = 0.9, lty=2, lwd=1, col='black') +
  geom_abline(slope = 1.1, lty=2, lwd=1, col='black') 
f1b <- ggplot(data=join, aes(x=lagTFR, y=xTFR, text = paste(Code, Year))) +
  geom_text(x=1.5, y=3.5, label="xTFR", col='blue', size=6)+
  annotation_custom(my_grobb)+
  geom_point(size=1, alpha=.50,color='gray') +
  geom_abline(intercept=0,slope=1) +
  geom_abline(intercept=0, slope = 0.9, lty=2, lwd=1) +
  geom_abline(intercept=0, slope = 1.1, lty=2, lwd=1) +
  theme_bw() +
  theme(text=element_text(face='bold')) +
  xlim(0.9,4.1) + ylim(0.9,4.1) +
  labs(x='TFR (Data)', y='p(TFR)') 
f1c <- ggplot(data=join, aes(x=lagTFR, y=bayesTFR, text = paste(Code))) +
  geom_text(x=2, y=3.5, label="BayesTFR", col='green', size=6)+
  annotation_custom(my_grobc)+
  geom_point(size=1, alpha=.50,color='gray') +
  geom_abline(intercept=0,slope=1) +
  theme_bw() +
  theme(text=element_text(face='bold')) +
  xlim(0.9,4.1) + ylim(0.9,4.1) +
  labs(x='TFR (Data)', y='p(TFR)') +
geom_abline(slope = 0.9, lty=2, lwd=1, col='black') +
  geom_abline(slope = 1.1, lty=2, lwd=1, col='black') 


f1d <- ggplot(data=join, aes(x=C, y=(iTFR-lagTFR)/lagTFR*100)) +
  annotation_custom(my_grobd)+
  geom_point(size=1, alpha=.50,color='gray')+
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 10, lty=2, lwd=1)+
  geom_hline(yintercept = -10, lty=2, lwd=1)+
  theme_bw() +
    theme(text=element_text(face='bold')) +
  ylim(-30,30) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  labs( x='Population, n', y='M(TFR)') 
f1e<-ggplot(data=join, aes(x=C, y=(xTFR-lagTFR)/lagTFR*100)) +
  annotation_custom(my_grobe)+
  geom_point(size=1, alpha=.50,color='gray')+
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 10, lty=2, lwd=1)+
  geom_hline(yintercept = -10, lty=2, lwd=1)+
  theme_bw() +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  theme(text=element_text(face='bold')) +
  ylim(-30,30) +
  labs(x='Population, n', y='M(TFR)')
f1f <- ggplot(data=join, aes(x=C, y=(bayesTFR-lagTFR)/lagTFR*100)) +
  annotation_custom(my_grobf)+
  geom_point(size=1, alpha=.50,color='gray')+
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 10, lty=2, lwd=1)+
  geom_hline(yintercept = -10, lty=2, lwd=1)+
  theme_bw() +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  theme(text=element_text(face='bold')) +
  ylim(-30,30) +
  labs( x='Population, n', y='M(TFR)')


f1g<- ggplot(data=join, aes(x=Year, y=(iTFR-lagTFR)/lagTFR*100)) +
  annotation_custom(my_grobg)+
  geom_point(size=1, alpha=.50,color='gray')+
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 10, lty=2, lwd=1)+
  geom_hline(yintercept = -10, lty=2, lwd=1)+
  theme_bw() +
  theme(text=element_text(face='bold')) +
  xlim(1891,2015) + ylim(-30,30) +
  labs(x='Time, t', y='M(TFR)') 
f1h<- ggplot(data=join, aes(x=Year, y=(xTFR-lagTFR)/lagTFR*100)) +
  annotation_custom(my_grobh)+
  geom_point(size=1, alpha=.50,color='gray')+
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 10, lty=2, lwd=1)+
  geom_hline(yintercept = -10, lty=2, lwd=1)+
  theme_bw() +
  theme(text=element_text(face='bold')) +
  xlim(1891,2015) + ylim(-30,30) +
  labs(x='Time, t', y='M(TFR)') 
f1i<- ggplot(data=join, aes(x=Year, y=(bayesTFR-lagTFR)/lagTFR*100)) +
  annotation_custom(my_grobi)+
  geom_point(size=1, alpha=.50,color='gray')+
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 10, lty=2, lwd=1)+
  geom_hline(yintercept = -10, lty=2, lwd=1)+
  theme_bw() +
  theme(text=element_text(face='bold')) +
  xlim(1891,2015) + ylim(-30,30) +
  labs(x='Time, t', y='M(TFR)') 


f1j<- ggplot() +
  annotation_custom(my_grobj)+
  geom_density(data=join, aes(x=iTFR-lagTFR), adjust=1.5,fill='red',col='red', lwd=1, alpha=.20) +
  geom_density(data=join, aes(x=bayesTFR-lagTFR),adjust=1.5, fill='green',col='green', lwd=1, alpha=.20) +
  geom_density(data=join, aes(x=xTFR-lagTFR), adjust=1.5, fill="blue", col="blue", lwd=1, alpha=.20)+
  geom_vline(xintercept=0) +
  theme_bw() +
  xlim(-0.5,0.5) + 
  geom_vline(data=join, aes(xintercept=quantile((iTFR-lagTFR), 0.9, na.rm=T)), lty=2, lwd=0.5, color="red") +
  geom_vline(data=join, aes(xintercept=quantile((iTFR-lagTFR), 0.1, na.rm=T)), lty=2, lwd=0.5, color="red") +
  geom_vline(data=join, aes(xintercept=quantile((bayesTFR-lagTFR), 0.9, na.rm=T)), lty=2, lwd=0.5, color="green")+
  geom_vline(data=join, aes(xintercept=quantile((bayesTFR-lagTFR), 0.1, na.rm=T)), lty=2, lwd=0.5, color="green")+
  geom_vline(data=join, aes(xintercept=quantile((xTFR-lagTFR), 0.9, na.rm=T)), lty=2, lwd=0.5, color="blue")+
  geom_vline(data=join, aes(xintercept=quantile((xTFR-lagTFR), 0.1, na.rm=T)), lty=2, lwd=0.5, color="blue")+
  theme(text=element_text(face='bold')) +
  labs(x='Algebraic(error)',
       y='Density')
f1k<- ggplot() +
  annotation_custom(my_grobk)+
  geom_density(data=join, aes(x=abs((iTFR-lagTFR))), adjust=1.5,fill='red',col='red', lwd=1, alpha=.20) +
  geom_density(data=join, aes(x=abs((bayesTFR-lagTFR))),adjust=1.5, fill='green',col='green', lwd=1, alpha=.20) +
  geom_density(data=join, aes(x=abs((xTFR-lagTFR))), adjust=1.5, fill="blue", col="blue", lwd=1, alpha=.20)+
    geom_vline(xintercept=0) +
  theme_bw() +
  xlim(0,+0.50) + 
  geom_vline(data=join, aes(xintercept=quantile(abs((iTFR-lagTFR)), 0.5, na.rm=T)), lty=1, lwd=0.5, color="red") +
  geom_vline(data=join, aes(xintercept=quantile(abs((xTFR-lagTFR)), 0.5, na.rm=T)), lty=1, lwd=0.5, color="blue") +
  geom_vline(data=join, aes(xintercept=quantile(abs((bayesTFR-lagTFR)), 0.5, na.rm=T)), lty=1, lwd=0.5, color="green")+
  geom_vline(data=join, aes(xintercept=quantile(abs((iTFR-lagTFR)), 0.9, na.rm=T)), lty=2, lwd=0.5, color="red")+
  geom_vline(data=join, aes(xintercept=quantile(abs((xTFR-lagTFR)), 0.9, na.rm=T)), lty=2, lwd=0.5, color="blue")+
  geom_vline(data=join, aes(xintercept=quantile(abs((bayesTFR-lagTFR)), 0.9, na.rm=T)), lty=2, lwd=0.5, color="green")+
  theme(text=element_text(face='bold')) +
  labs(x='Absolute Algebraic(error)',
       y='Density')
f1l<- ggplot() +
  annotation_custom(my_grobl)+
  geom_density(data=join, aes(x=abs((iTFR-lagTFR)/lagTFR)*100), adjust=1.5,fill='red',col='red', lwd=1, alpha=.20) +
  geom_density(data=join, aes(x=abs((bayesTFR-lagTFR)/lagTFR)*100),adjust=1.5, fill='green',col='green', lwd=1, alpha=.20) +
  geom_density(data=join, aes(x=abs((xTFR-lagTFR)/lagTFR)*100), adjust=1.5, fill="blue", col="blue", lwd=1, alpha=.20)+
  geom_vline(xintercept=0) +
  theme_bw() +
  geom_vline(data=join, aes(xintercept=quantile(abs((iTFR-lagTFR)/lagTFR)*100, 0.5, na.rm=T)), lty=1, lwd=0.5, color="red") +
  geom_vline(data=join, aes(xintercept=quantile(abs((xTFR-lagTFR)/lagTFR)*100, 0.5, na.rm=T)), lty=1, lwd=0.5, color="blue") +
  geom_vline(data=join, aes(xintercept=quantile(abs((bayesTFR-lagTFR)/lagTFR)*100, 0.5, na.rm=T)), lty=1, lwd=0.5, color="green")+
  geom_vline(data=join, aes(xintercept=quantile(abs((iTFR-lagTFR)/lagTFR)*100, 0.9, na.rm=T)), lty=2, lwd=0.5, color="red")+
  geom_vline(data=join, aes(xintercept=quantile(abs((xTFR-lagTFR)/lagTFR)*100, 0.9, na.rm=T)), lty=2, lwd=0.5, color="blue")+
  geom_vline(data=join, aes(xintercept=quantile(abs((bayesTFR-lagTFR)/lagTFR)*100, 0.9, na.rm=T)), lty=2, lwd=0.5, color="green")+
  theme(text=element_text(face='bold')) +
  labs(x='Absolute Percent(error)',
       y='Density')



grid.arrange(f1a,f1b,f1c,f1d, f1e, f1f, f1g, f1h, f1i, f1j, f1k, f1l, ncol=3)


```

We verify the accuracy of the three derivations using data from the Human Fertility Database and Human Mortality Database [@HFD;@HMD] for nearly 1,800 fertility schedules between 1891 and 2015 across 30 countries (see Table \ref{HFDCountries} in the Supplementary Materials for a complete list). This dataset comprises only complete, official vital event statistics and is the most complete and accurate collection of observed fertility data compiled to date (\textbf{Fig. 1}). We find good agreement between our implied fertility rates and the observed TFRs for all three methods (\textbf{Fig. 1, a, b, c}). Typically demographic parameters increase in accuracy as population sizes increase due to the law of large numbers, and they tend to be more accurate in more recent time periods due to improved data collection practices. However, we find that error rates are independent of population size and scale (\textbf{Fig. 1, d, e, f}) and do not vary across time (\textbf{Fig. 1, g, h, i}), suggesting scale- and temporal- independence uncommon in other indirect methods. Additionally, all three methods on average estimated total fertility within 0.1 observed births, with 90\% of estimates from the poorest performing method within 0.25 births (\textbf{Fig. 1, j, k}). Finally, 90\% of estimates were within 11\% of the observed value, regardless of derivation, with the average estimates within 5\% of the observed TFRs. Taken together, these results suggest a robust method with applicability across space and time, with better performance with additional model parameters. Even the simplest derivation with the least data requirements, implied fertility rate itself, produces accurate estimates of the TFR.

\begin{table}
\centering
\caption{\textbf{Summary statistics of the three derivations of the iTFR using data from the HFD and HMD.} APE is the Absolute Percent Error and RMSE is the Root Mean Squared Error. Overall, the methods produce TFR estimates on average within less than 1/10th of a birth.}
\medskip
\resizebox{\textwidth}{!}{\begin{tabular}{lcccc}
\hline
\textbf{Method} & \textbf{50th Percentile APE} & \textbf{90th Percentile APE} & \textbf{50th Percentile Absolute Error} & \textbf{90th Percentile Absolute Error} \\ \hline
iTFR            & `r round(itfrape50,2)`\%   & `r round(itfrape90,2)`\%   & `r round(itfrabs50,3)`   & `r round(itfrabs90,3)`    \\
xTFR            & `r round(xtfrape50,2)`\%   & `r round(xtfrape90,2)`\%   & `r round(xtfrabs50,3)`  & `r round(xtfrabs90,3)`    \\
BayesTFR        & `r round(bayestfrape50,2)`\% & `r round(bayestfrape90,2)`\%   & `r round(bayestfrabs50,3)` & `r round(bayestfrabs90,3)` \\
\hline
\end{tabular}}
\end{table}


\textbf{Table 1} reports the summary statistics for all three derivations. All three methods produce TFRs within approximately one-tenth of a child, with the best performing method producing estimates within one-twentieth of a child. Ninety percent of estimates are within one-quarter of a birth and have an average error rate less than 5%. This is significant improvement upon previous indirect estimation methods [@hauer13].

```{r movement, echo= FALSE, message = FALSE, warning = FALSE, fig.cap= paste("**iTFR using Primate Fertility Data**. We test the iTFR using data from seven wild primate species [@bronikowski16;@bronikowskidata]. These species exhibit markedly different menarche and menopause, length of fertility schedule, and fertility tempo from each other and from humans. We plot the observed TFR against the estimated TFR using the iTFR formulation. The solid line is Y=X, and the dashed lines represent +/- 10% of Y=X. Overall the iTFR performs remarkably well across the seven primate species, losing very little accuracy for species with markedly different fertility characteristics.\\label{primates}")}

###   Making the Primate graphic
ggplot(combined, aes(x = TFR_table, y = iTFR)) +
  geom_point(shape = 19, color = 'gray', size = 3) +
  geom_text_repel(aes(label = Species), hjust = 0, vjust = 0) +
  theme_bw() +
  geom_abline(slope = 1) +
  xlim(5, 11) +
  ylim(5, 11) +
  theme(text = element_text(face = 'bold')) +
  geom_line(aes(x = TFR_table, y = 0.9 * TFR_table), lty = 2, lwd = 1, col = 'black') +
  geom_line(aes(x = TFR_table, y = 1.1 * TFR_table), lty = 2, lwd = 1, col = 'black') +
  labs(x = 'TFR(Data',
       y = 'p(TFR)')
```

To test the generalizability of the method, we examine the accuracy of the implied fertility derivation in seven non-human primate populations (**\autoref{primates}**). These populations vary substantially in population size and fertility patterns, allowing us to assess whether the methods work across species. In contrast to humans with a fertility length of 35-40 years and menarche and menopuase typically demarcated at 15-49 years old, menarche among the seven primate species ranged from a low of three years old with Sifakas (*Propithecus verreauxi*) to a high of 11 years old with Chimpanzees (*Pan troglodytes*), and fertility length ranged from a low of 22 years for Capuchins (*Cebus capucinus*) to a high of 45 years for Chimpanzees. These species display fertility intervals, fertility schedules, and TFRs that differ greatly from humans. We find that implied fertility accurately estimates total fertility among these species (**\autoref{primates}**). Remarkably, this simple method with quite limited data requirements can accurately estimate total fertility across such diversity. Our results with nonhuman primates suggest the method captures fundamental patterns that govern fertility and that it can nearly universally be applied to a wide span of previously inestimable populations, time periods, geographies, and possibly species.

The three panel plots in (\textbf{Fig. 3}) demonstrate the flexibility of the method, depending on data availability, and how it greatly expands our ability to estimate fertility across geographies, time periods, and subpopulations. The National Center for Health Statistics does not publish fertility information for US Counties with populations fewer than 100,000 for privacy reasons. As a result, fertility can be estimated in only 500 of the approximately 3000 US Counties, significantly hindering the examination of sub-national fertility patterns. We use data collected from the 2010 US Census to produce robust estimates for all US counties using the xTFR method. We are then able to create the first complete county-level map of US fertility (\textbf{Fig. 3, a}). We also extended our analysis of the Human Mortality Database for three additional example countries: France, the Netherlands, and Sweden (\textbf{Fig. 3, b}). The Netherlands began collecting detailed birth records in 1950, France in 1946, and Sweden in 1891. However, these countries collected both mortality and age-sex data considerably earlier (Netherlands in 1850, France in 1816, and Sweden in 1751). By using the BayesTFR method, we can reconstruct historical TFRs to create a time series of fertility data well before birth record collection began, significantly improving our ability to explore historical fertility patterns from up to 250 years ago. In (\textbf{Fig. 3, c}) we use the basic iTFR method to estimate TFRs by household income in the United States using data from the US Census Bureau's American Community Survey (ACS). The United States does not record fertility or mortality data by household income, precluding the use of the BayesTFR method. In addition, the ACS data have more statistical accuracy when estimates are pooled, precluding the use of the xTFR method, due to pooling women by age. However, by linking age-sex data to household income, we estimate TFR by income, a subpopulation previously unmeasured.

```{r fig3, echo= FALSE, message = FALSE, warning = FALSE, fig.height=6.5, fig.cap= paste("**Revealing latent fertility patterns.** We demonstrate that the iTFR framework can be used in a variety of situations. (a) uses the xTFR method to estimate total fertility rates in US Counties based on Census 2010 data. The National Center for Health Statistics masks fertility data for counties with fewer than 100,000 people for privacy reasons making fertility estimates possible for only 524 of the approximately 3000 US counties. The darker counties are the counties with actual fertility data. (b) uses the BayesTFR method to estimate historic fertility rates in three European countries using data from the Human Mortality Database. The vertical lines correspond to when birth registration began in each country. The shaded regions represent the 90th percentile. (c) uses the iTFR method on household income data from the Census Bureau's American Community Survey. Birth registration is not recorded by income group, but we are able to estimate fertility rates using household survey data. These three examples represent previously inestimable populations by geography, time period, and sub-population and demonstrate the methodological flexibility of the iTFR framework. \\label{figure3}")}

pal <- c("#4475B5", "#849EBA", "#BFCCBD", "#ffffbf", "#F9B984", "#ED7550", "#D62F26")

a<- tm_shape(countiestfr, projection = "laea_NA") +
  tm_polygons("xTFR",
              palette = pal , 
              breaks= c(-Inf, 1.0, 1.5, 2.1, 2.5, 3.0, 3.5, Inf),
              auto.palette.mapping = FALSE, 
              id = "GEOID", 
              #showNA = TRUE, 
              border.col = "gray50", 
              border.alpha = 0.4,
              alpha = 0.4,
              legend.show = FALSE
              #style ="jenks",
              #n = 6
  ) +
 tm_shape(countiestfr2) +
 tm_polygons("xTFR",
              palette = pal , 
              breaks= c(-Inf, 1.0, 1.5, 2.1, 2.5, 3.0, 3.5, Inf),
              auto.palette.mapping = FALSE, 
              id = "GEOID", 
              #showNA = TRUE, 
              colorNA = NULL,
              border.col = "black", 
              lwd = 0.5
              #border.alpha = 0.5
              #legend.show = FALSE
              #style ="jenks",
              #n = 6
  ) +
 tm_shape(states) +
  tm_borders(lwd=2, col="black", alpha = 0.5) +
 tm_credits("a", position=c("left", "top"))

results <- read.csv('hmdall_06172017.csv')

#my_groba = grobTree(textGrob("a", x=0.1, y=0.95, hjust=0, gp=gpar(col="black", size=6)))
my_grobb = grobTree(textGrob("b", x=0.1, y=0.9, hjust=0, gp=gpar(col="black", size=6)))
my_grobc = grobTree(textGrob("c", x=0.1, y=0.9, hjust=0, gp=gpar(col="black", size=6)))

f3b <- ggplot() +
  annotation_custom(my_grobb)+
  geom_line(data=subset(results, Code %in% c("NLD", "SWE", "FRATNP")), aes(x=Year, y=post_mean, color=factor(Code, labels = c("France", "Netherlands", "Sweden")))) +
  geom_ribbon(data=subset(results, Code %in% c("NLD", "SWE", "FRATNP")), aes(x=Year, ymin=Q10, ymax=Q90,fill=factor(Code, labels = c("France", "Netherlands", "Sweden"))), alpha=0.2, show.legend = FALSE) +
  geom_ribbon(data=subset(results, Code =="NLD" & Year <=1950), aes(x=Year, ymin=Q10, ymax=Q90), fill="green", alpha=0.2, show.legend = FALSE) +
  geom_ribbon(data=subset(results, Code =="SWE" & Year <=1891), aes(x=Year, ymin=Q10, ymax=Q90), fill="blue", alpha=0.2, show.legend = FALSE) +
  geom_ribbon(data=subset(results, Code =="FRATNP" & Year <=1946), aes(x=Year, ymin=Q10, ymax=Q90), fill="red", alpha=0.2, show.legend = FALSE) +
  theme_bw() +
  theme(text=element_text(face='bold', size = 8),
        legend.text=element_text(size=5))+
  theme(legend.position=c(0.87,0.8),
        legend.key.size = unit(0.3, "cm")) +
  labs(x='Year', y='BayesTFR', color = "Country") +
  geom_vline(xintercept=1950,lty=1, lwd=1, color="Green") +
  geom_vline(xintercept=1891,lty=1, lwd=1, color="Blue") +
  geom_vline(xintercept=1946,lty=1, lwd=1, color="Red") +
  scale_x_continuous(breaks = c(1750,1800,1850, 1900, 1950, 2000))

income <-read.xlsx("test_income_itfr_06222017.xlsx")

incomelabels <- c("0-24", "25-49", "50-74", "75-99", "100-124", "125-149", "150-199", "200-249", "250-499", "500-999", "1000+")

f3c <- ggplot() +
  annotation_custom(my_grobc) +
  geom_line(data=income, aes(x=Income.Bracket, y=iTFR)) +
  ylim(0,+2.50) +
  theme_bw() +
  #theme(aspect.ratio=1) +
  labs(x="Income (in 000s)")+
  theme(text=element_text(face='bold'), axis.text.x = element_text(angle=45, hjust=1)) +
  scale_x_discrete(limits=incomelabels)

grid.newpage()
pushViewport(viewport(layout=grid.layout(3,2)))
print(f3b, vp = viewport(layout.pos.col = 1, layout.pos.row = c(3)))
print(f3c, vp = viewport(layout.pos.col =2, layout.pos.row =c(3)))

print(a, vp = viewport(layout.pos.row =c(1,2)))
```


Researchers can tailor the method they use to the data available or the research question due to the flexible data requirements, a rare feature in methodologies, and can do so with confidence in the accuracy of the resultant estimates. As we show in \textbf{Fig 3.}, the applications of such a robust, simple method cannot be understated. The implied fertility rate opens the door for sophisticated fertility analyses in many previously inestimable populations of interest to sociologists [@lesthaeghe14], economists [@hotz1997economics], anthropologists [@greenhalgh1995situating], epidemiologists [@paulson2002pregnancy], and population geographers [@sorichetta2015high]. The parameter-free, scale-, time-, and species- robust technique can estimate fertility rates even in areas where such data are not collected systematically as it relies only on age-sex data -- ubiquitous basic data collected in censuses across scale and time.

We anticipate this method will open up new lines of inquiry into human fertility patterns. The global demographic transition is typically examined post-1950[@bongaars09]; however, using age-sex structure data, researchers can examine the global demographic transition in greater detail further back in time. Relatedly, re-creations of historic human fertility rates rely on estimates of energy balance and the relative metabolic load or a universal density-dependent demographic model [@bocquet11]. Using the methods proposed here, anthropologists could re-create historic human fertility rates directly from skeletal remains or cemetery information while accounting for underenumeration and child-mortality. Finally, there has been an increased demand for high-resolution gridded population datasets related to climate change research [@jones15;@cincotta00]. Our methods could be used to estimate fertility levels and change as either inputs for gridded population projections or for the production of gridded fertility level datasets due to the demonstrated scale independence. 


## Competing Interests
The authors declare that they have no competing financial interests.

\newpage
\newpage

# Supplementary Information

## Data:

**Human Fertility Database**. Data on fertility patterns come from the Human Fertility Database[@HFD]. These data represent the most complete and accurate historical pattern of human fertility currently available. The fertility rates are entirely based on official vital statistics and are not modelled. The HFD covers fertility schedules for 34 countries between 1891 and 2015. In total, the HFD contains 1,870 country-years of total fertility rates.

\begin{table}
  \centering
  \caption{Human Fertility Database Countries and years of data availability.}
    \begin{tabular}{llll}
\hline
    Country & Data Availability & Country & Data Availability\\
\hline
Austria	& 1951-2014	& Netherlands	& 1950-2012\\
Belarus	 & 1964-2014	& Norway	& 1967-2014\\
Bulgaria	& 1947-2009	& Portugal	& 1940-2015\\
Canada	& 1921-2011	& Russian Federation	& 1959-2014\\
Chile	& 1992-2005	& Slovakia	& 1950-2009\\
Czech Republic	& 1950-2014	& Slovenia	& 1983-2014\\
Estonia	& 1959-2013	& Spain	& 1922-2014\\
Finland	& 1939-2015	& Sweden	& 1891-2014\\
France	& 1946-2013	& Switzerland	& 1932-2014\\
Germany	& 1990-2013	& Taiwan	& 1976-2014\\
Hungary& 	1950-2014	& Ukraine	& 1959-2013\\
Iceland	& 1960-2010	& England \& Wales	& 1938-2013\\
Italy	& 1954-2012	& Scotland	& 1945-2013\\
Japan	& 1947-2014	& Northern Ireland	& 1974-2013\\
Lithuania	& 1959-2013	& United States of America	& 1933-2014\\

    \end{tabular}%
  \label{HFDCountries}%
\end{table}

**Human Mortality Database**. Data on mortality rates come from the Human Mortality Database [@HMD]. These data represent the most complete and accurate historical pattern of human mortality currently available. Mortality rates come from official death counts from vital statistics, census counts, birth counts, and population estimates from varying sources. $Q_x$ values and population counts used in this analysis were gathered from this data source.

**Primate data**. Primate age-specific fertility data come from Bronikowski et al [@bronikowski16;@bronikowskidata]. These data contain female age-specific fertility estimates for seven wild primates: sifaka (*Propithecus verreauxi*) in Madagascar, muriqui (*Brachyteles hypoxanthus*) in Brazil; capuchin (*Cebus capucinus*) in Costa Rica; baboon (*Papio cynocephalus*) and blue monkey (*Cercopithecus mitis*) in Kenya; chimpanzee (\textit{Pan troglodytes}) in Tanzania; and gorilla (*Gorilla beringei*) in Rwanda. The primate species were continuously monitored for at least 29 years. The fertility data are estimated in single-year intervals.

**US County Fertility**.

**The implied Total Fertility Rate**

We propose two derivations or extensions of the implied total fertility rate from the main text and describe the formulation in greater detail.

TFR is the expected number of children born over a complete reproductive lifetime at current age-specific rates. It is notated as

\begin{equation}{TFR}
   =\int_{\alpha}^{\beta}\,f(x)\,dx \label{eq:exact TFR integral} 
\end{equation}

where $f(x)$ is the fertility rate (births per woman-year) at exact age $x$ and $[\alpha,\beta]$ is the range of ages with non-zero fertility. In practice scholars approximate $f(x)$ with a step function that has a constant rate $F_x$ within each $n$-year age interval $[x,x+n)$. $F_x$ values are estimated as ratios of annual births to women in each age group ($B_x$) to their mid-year populations ($W_x$).

TFR is then calculated as 

\begin{equation}{TFR}
    = \: n\cdot\displaystyle\sum_{x=\alpha}^{\beta-n}\frac{B_x}{W_x} \label{eq:exact TFR} 
\end{equation}

Fertility calculations imply that the expected number of surviving children of both sexes per woman in reproductive age groups at the end of an $n$-year period, which we call $K_a$ is

\begin{eqnarray}
K_{a}\, & = & \,\,\left[\frac{L_{a-5}}{L_{a}}\,\cdot F_{a-5}\;+\; F_{a}\right]\,\,\frac{L_{0}}{2}\label{eq:Ka}\\
 & = & \,\, TFR\,\cdot\frac{L_{0}}{5}\cdot\,\frac{1}{2}\,\left(\frac{L_{a-5}}{L_{a}}\,\cdot\phi_{a-5}\;+\;\phi_{a}\right)\nonumber \\
 & = & \,\, TFR\,\cdot s_{0}\cdot\, p_{a}\nonumber 
\end{eqnarray}

where $F_a$ is the average fertility rate over exact ages $[a,a+5)$; $\phi_a$ is the fraction of total fertility occurring in age group a $(_5F_a/TFR)$; $L_a$ is the expected person-years lived in age group $a$, in a life table with a radix $l_0=1$; $s_0$ is the expected fraction still alive among children born in the past five years $(l_0/5)$; $W_a$ is the observed women in age group $a$; and $W$ is the total number of women at childbearing ages $[15, 50)$.

We can decompose the right-hand side of $K_a$ into three multiplicative factors: the total fertility rate, child survival, $s_0$, and age-structure fertility, $p_a$.

If we examine the expected total number of surviving 0-4 year olds in a given population that contains women of childbearing ages 15-49:

\begin{equation}
C\,=\,\sum_{a=15}^{45}\, W_{a}\, K_{a}\,=\, TFR\,\cdot s_{0}\cdot\left(\sum_{a=15}^{45}\, W_{a}\, p_{a}\right)\label{eq:expected total C}
\end{equation}

then the number of surviving children becomes a product of the fertility rates, child survival, and tempo fertility ($W_ap_a$) or the timing of childbearing.

We then further refine equation (\ref{eq:expected total C}) to produce the child/woman ratio:

\begin{eqnarray}
\frac{C}{W} & = & TFR\,\cdot\, s_{0}\,\cdot\,\left(\sum_{a=15}^{45}\,\frac{W_{a}}{W}\, p_{a}\right)=\, TFR\,\cdot s_{0}\,\cdot\bar{p}\label{eq:CWRatio}
\end{eqnarray}

where $\bar{p}$ is the population-weighted average of lifetime fertility.

We can now rearrange equation (\ref{eq:CWRatio}) to solve for TFR such that

\begin{equation}
TFR\,=\,\frac{1}{s_{0}}\cdot\frac{1}{\bar{p}}\cdot\frac{C}{W}\label{eq:s0TFR}
\end{equation}

If women of childbearing ages in a given population are uniformly distributed across the fertility interval, then $\bar{p} =n$, where $n$ is the width of the fertility interval. If we assume near-zero child-mortality ($S_0=1$) and that women of childbearing ages are uniformly distributed across the fertility interval ( $\bar{p}=n$). We can then further simplify equation (\ref{eq:s0TFR}) into the implied total fertility rate, or the fertility rate that is implied by the age-sex structure of a given population. Here we have broadened the equation to include all possible widths of the fertility interval.

\begin{equation}
iTFR =\frac{\beta - \alpha}{n}\cdot \frac{ _{n}C_0}{W} 
\end{equation}

This derivation is remarkably similar to the general fertility rate ($B_t/_{40}W_{10}$) and age-specific fertility ($_nF_x = _nB_x/_nW_x$) with children substituted for births in both equations. This allows the iTFR to convert the C/W into $_nF_x$ and by extension, produce the indirect equivalent of the total fertility rate that is implied or intrinsic to the observed population age-sex structure freeing the estimation of TFR from its heavy data requirements.

**xTFR**

If women of reproductive age are uniformly distributed over the fertility interval, then the multiplier, $n$, will perfectly capture the width of the fertility interval. However, in practice, women are unlikely to be exactly uniformly distributed over the interval. We solved for the ideal multiplier in 1,859 fertility schedules in the HFD using women aged 15-49 and children aged 0-4 (ideal multiplier=7) and find multipliers ranging from a low of 4.52 (Taiwan 1986) to a high of 11.29 (France 1946). They are within 10% of the ideal multiplier (6.3-7.7) in 68.7% of the country-years. Ninety percent of all multipliers fall between 6.02 and 7.79.

However, fertility schedules typically follow a skewed distribution toward younger ages [@coale74;@Schmertmann03] and demonstrate a common shape across human populations with most fertility occurring between 20 and 34. We observed a strong relationship between the proportion of women aged 25-34 and the multiplier (Figure S1., r-squared=0.388). Other age groups had considerably lower r-squared values (15-24 = 0.163, 20-29 = 0.3492, 25-34 = 0.388, 30-39 = 0.179, 35-44 = 0.108, 40-49 = 0.096). We then modify the iTFR to account for this new information:

\begin{eqnarray}
xTFR=x \cdot \frac{C}{W}\\\label{eq:kTFR}
x=\beta_0 + \beta_1X_i \nonumber
\end{eqnarray}

where $X_i$ is the proportion of women aged 25-34 observed in population $i$. This formulation improves the estimates of total fertility (Fig. 1) but requires additional information about the distribution of women in the fertility interval. 


We test a derivation of the xTFR in a multiple regression based on the proportion of women in each five-year age group,

\begin{eqnarray}
xTFR=x \cdot \frac{C}{W}\\\label{eq:kTFR multiple regression}
x=\beta_0 + \beta_1X_i + \beta_2X_j... \beta_7X_7 \nonumber
\end{eqnarray}

However, we find that using the population aged 25-34 produced almost identical estimates with minimal loss of accuracy (supplementary figure X).

**Bayes TFR**

We extend our previous approach into a Bayesian framework relating the number of children aged 0-4 to women aged 15-49. The iTFR formulation outlined in sup. mat. section 2 does not account for the potential error associated with any of the given parameters. The xTFR incorporates additional information from the age structure to improve the estimates but does not account for infant mortality or possible estimation errors in the number of women of childbearing ages. $s_0$ and $\bar{p}$ cannot not be truly known and could be subject to random errors in measurement. 

We deconstruct the estimation of total fertility from equation (\ref{eq:s0TFR}) into $TFR$, $C$, $W$, $s_0$, and $\bar{p}$ producing a five-parameter model with four of the parameters deriving from the age-structure – $C$, $W$, $\bar{p}$, and $TFR$). The fifth parameter, $s_0$, is not information embedded within the age structure and most be supplied in addition to the age structure. These parameters can be broadly categorized as fertility ($TFR$, $\bar{p}$), mortality ($s_0$), and age structure ($W$) with the result of these quantities being the expected number of surviving children ($C$).

**Fertility Parameters**

We decompose the fertility schedule for 5-year age groups into two components: level and shape 

\begin{equation}
(F_{10}, F_{15},...,F_{45}= \frac{TFR}{5} \cdot (0,\phi_{15},...,\phi{45})
\end{equation}
 
where $TFR$ is the total fertility rate and $phi_a$ is the proportion of lifetime fertility that occurs in age group $a$. Fertility is negligible before age 15; thus, $F_10=0$. The proportions $\phi_{15}...\phi_{45}$ are rewritten into indices, such that $\gamma_{a}=\ln(\frac{\phi_a}{\phi_{15}})$ for $a=15...45$ such that $\phi_a(\gamma)= \frac{\exp(\gamma_{a})}{\sum_{z}\exp(\gamma_{z})}$ sum to one.

The $\gamma$ indices are modelled as $\gamma=m+X\beta$ where $m$ and $X$ are constants derived from empirical data (see section X.X) and $\beta$ are shape parameters. These three fertility parameters ($TFR$, $\beta_1$, $\beta_2$) yield eight 5-year fertility rates ($F_{10}...F_{45}:\beta \rightarrow \gamma \rightarrow \phi$ and $\frac{TFR}{5} \cdot \phi = F$.

We use a completely uninformative, improper prior for $TFR$: $f(TFR)\propto 1$. We assign higher probability to more typical fertility patterns by building the prior for $\beta$ coefficients from information in the HFD and the US Census Bureau's International Database [@CensusIDB] to create priors of the shape of the fertility schedule by age. We calculate $\gamma$ indices for $F_{a}$ empirical schedules (n=226 from the IDB, n=411 from the HFD), and then performed a singular value decomposition on the (de-meaned) 6x637 $\gamma$ array. This produces a model in which each of the 637 columns of $\gamma$ could be well approximated by the mean vector plus a weighted sum of two principal components: $\gamma_{i}\approx m+X\beta_{i}$. We scale the two columns of $X$ so that $\beta_{i}$ coefficients
have zero means, unit variances, and zero covariances over the empirical data $i=1 \ldots 637$. These calculations produce constants $X= \begin{matrix}0 & 0.27 & 0.54 & 0.73 & 0.88 & 1.04 & 1.52\\0 & 0.32 & 0.51 & 0.51 & 0.35 & 0.05 & -0.72 \end{matrix}^{\prime}$, with which we use the prior 

\begin{equation}
\beta\,\sim N(0,I_2)\label{eq:prior for beta}
\end{equation}

with support restricted to the range [-2,+2] for each $\beta$ coefficient, in order to better mimic the HFD distributions. When we examine the $X$ matrix, we find that $\beta_{1}$ affects the mean age of childbearing and $\beta_{2}$ affects the variance: If $\beta_1$ is higher, fertility is postponed; if $\beta_2$ is higher, fertility is concentrated in fewer age groups.

*Mortality Parameters*

We model child and adult mortality with a two-parameter relational mortality model [@wilmoth2012flexible]. The probability of death before age five ($q_5$) and a shape parameter $k$ with typical values between -2 and +2 index the mortality schedule. The model uses fixed constants $\left\{a_x,b_x,c_x,v_x\right\}$ derived from mortality schedules in the Human Mortality Database:

\begin{equation}
\ln\,\mu_{x}(q_{5},k) = a_{x}+b_{x}\,\left[\ln\, q_{5}\right]+c_{x}\,\left[\ln\, q_{5}\right]^{2}+v_{x}\, k\quad,\quad x=0,1,5,10 \ldots 45
\end{equation}

Mortality rates $\mu_0$ and $\mu_1$ refer to age intervals $[0,1)$ and $[1,5)$, $\mu_x$ refers to 5-year age intervals $[x,x+5)$ for all other age groups. $q_5=1-l_5$ is a model parameter, meaning there are no $\left\{a_x,b_x,c_x,v_x\right\}$ constants for calculating $\mu_1$; instead, $\mu_1$ is calculated by $\mu_{1}=-\tfrac{1}{4}\left[\mu_{0}+\ln\left(1-q_{5}\right)\right]$.

We convert log mortality rates into life table person-years, $L_a$, for 5-year age intervals $[a,a+5)$ using standard demographic approximations. Survival probabilities to exact ages are $l_{0}=1$, $l_{1}=e^{-\mu_{0}}$,
$l_{5}=l_{1}\cdot e^{-4\mu_{1}}$, and $l_{x}=l_{x-5}\cdot e^{-5\mu_{x-5}}$
for $x=10\ldots45$. Life table person-years are $L_{0}=\frac{1}{2}\left(l_{0}+l_{1}\right)+\frac{4}{2}\left(l_{1}+l_{5}\right)$
and $L_{a}=\frac{5}{2}\left(l_{a}+l_{a+5}\right)$ for $a=5\ldots45$.
Thus the two mortality parameters $\left(q_{5},k\right)$ yield 10 $L_{a}$
values $(L_{0},L_{5}\ldots L_{45}).$


To account for the uncertainty in the mortality estimates, we use a beta distribution of $q_5$ (denoted as $\hat{q}_5$). The prior is defined as

\begin{equation}
q_5 \sim Beta[a(\hat{q}_5), b(\hat{q}_5)]\label{eq:prior for q5}
\end{equation}

where $a(\hat{q}_5)$ and $b(\hat{q}_5)$ are chosen so that $P[q_{5}<\tfrac{1}{2}\,\min(\hat{q}_{5})]\:=\: P[q_{5}>2\,\max(\hat{q}_{5})]\:=\:.05$. This assigns a 90% prior probability that under-five mortality $q_5$ is between one-half and twice the observed $q_5$ value.

For the shape parameter $k$, we use the prior
\begin{equation}
k \sim N(0,1) \label{eq:prior for k}
\end{equation}

which centers the distribution at zero and has a low probability of falling out of the $[-2,+2]$ range. We assume that mortality parameters $q_5$ and $k$ are independent.

The values for parameters ($TFR$, $\beta$, $q_5$, $k$) imply specific values $K_a$ in equation \ref{eq:Ka}. The expected number of children to the $W_{a}$
women observed in age group $a$ is $W_{a}K_{a}$, and the observed
number of surviving children may be modeled as 
$C_{a}\;\sim\; Poisson(\, W_{a}\, K_{a}\,)$. It is reasonable to assume that $C_{a}$ values are statistically
independent, conditional on fertility and mortality rates, so that
their sum $C=\sum_{a}C_{a}$ is also a Poisson random variable. Thus,
\begin{equation}
C|W,TFR,\beta,q_5,k \sim Poisson \Bigg[ \sum_{a=15}^{45}W_aK_a(TFR,\beta,q_5,k) \Bigg] \label{eq:poisson distribution of C}
\end{equation}


\textbf{Posterior Distribution of TFR}

The posterior for parameters conditional on data is
\begin{equation}
P(TFR,\beta, q_5,k | C,W) \propto L(C|W,TFR,\beta,q_5,k) f_\beta(\beta)f_q(q_5)f_k(k)  \label{eq:joint posterior}
\end{equation}

where the likelihood on the right-hand side is the Poisson likelihood
in (\ref{eq:poisson distribution of C}), and the $f$ functions represent
the prior densities implied by (\ref{eq:prior for beta}), (\ref{eq:prior for q5}),
and (\ref{eq:prior for k}), respectively. Note that the improper flat prior for $TFR$ does not affect the posterior distribution.

The marginal posterior for TFR, which expresses the relative probabilities
of alternative fertility levels given the number of children $C$
and the counts of women $W_{15}\ldots W_{45}$, is 

\begin{equation}
P(TFR | C,W) \propto \int L(C|W,TFR,\beta,q_5,k)f_\beta(\beta)f_{q}(q_5) f_k(k) d \beta\ d q_5\ d k\
\label{eq:marginal posterior of TFR}
\end{equation}


In practice, we sample from the full posterior distribution in (\ref{eq:joint posterior}) by applying Markov Chain Monte Carlo (MCMC)
methods. Specifically, we program the model in the \textit{Stan} MCMC language [@stanjss2017], as implemented in the \textit{rstan} package in \textit{R} [@rstanpackage;@Rlanguage]. We use the empirical density of the sampled $TFR$
values to estimate the marginal posterior of $TFR$ in (\ref{eq:marginal posterior of TFR}).
